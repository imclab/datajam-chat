(function(l,h,k){h("chat/init","datajam/init chat/libs/underscore_mixins chat/libs/jquery.imagesloaded chat/libs/jquery.scrollTo-1.4.2-min chat/libs/jquery.form //cdnjs.cloudflare.com/ajax/libs/moment.js/1.7.0/moment.min.js //platform.twitter.com/widgets.js".split(" "),function(){window.Datajam||(Datajam={});Datajam.Chat={models:{},views:{},collections:{}};Datajam.Chat.constants={deleted_message_text:"[deleted]"}});h("chat/collections/message",["chat/init"],function(){var c=jQuery,e=Datajam.Chat;
e.collections.Message=Backbone.Collection.extend({add:function(b,a){_.isArray(b)?c.each(b,_.bind(function(b,c){c=this._clean(c);this.handle_message(c,a)},this)):(model=this._clean(b),this.handle_message(model,a));return this},handle_message:function(b,a){var f=this.get(b._id);f?b.updated_at>f.get("updated_at")&&(b.text&&b.text!=e.constants.deleted_message_text?f.set(b):b.text==e.constants.deleted_message_text&&this.remove(f)):b.text&&b.text!=e.constants.deleted_message_text&&Backbone.Collection.prototype.add.call(this,
b,a)},comparator:function(b){return 0-b.get("timestamp").toDate().valueOf()},parse:function(b){var a="/chats/"+b.chat._id+"/pages/"+b.page._id+".json";"undefined"==typeof this._oldest_seen_page&&(this._oldest_seen_page=a);"undefined"==typeof this._newest_seen_page&&(this._newest_seen_page=a);a==this._oldest_seen_page&&(this._oldest_seen_page=b.page.prev_page);a==this._newest_seen_page&&b.page.next_page&&(this._newest_seen_page=this.url=b.page.next_page);!b.chat.is_open&&!b.chat.is_archived&&!_.isEqual(b.chat,
this.view.model.toJSON())?this.view.close():!b.chat.is_open&&(b.chat.is_archived&&!_.isEqual(b.chat,this.view.model.toJSON()))&&this.view.archive();return b.page.messages},_clean:function(b){b.timestamp=moment(b.updated_at,"YYYY-MM-DDTHH:mm:ss");return b}})});h("chat/collections/moderator_message",["chat/init"],function(){Datajam.Chat.collections.ModeratorMessage=Backbone.Collection.extend({comparator:function(c){return Date.parse(c.get("updated_at"))},parse:function(c){return c.messages}})});h("chat/models/chat",
["chat/init"],function(){Datajam.Chat.models.Chat=Backbone.Model.extend({defaults:{ajaxOptions:{cache:jQuery.browser.msie?!1:!0}},initialize:function(){},isNew:function(){return!1},parse:function(c){var e;e=c.chat;try{e._newest_seen_page="/chats/"+c.chat._id+"/pages/"+c.page._id+".json",e._oldest_seen_page=c.page.prev_page||e._newest_seen_page}catch(b){e._newest_seen_page=null,e._oldest_seen_page=null}e._submit_url=this.url.replace(".json","/messages.json");return e}})});h("chat/models/message",["chat/init"],
function(){Datajam.Chat.models.Message=Backbone.Model.extend({})});h("chat/models/moderator_chat",["chat/init"],function(){Datajam.Chat.models.ModeratorChat=Backbone.Model.extend({defaults:{},initialize:function(){},isNew:function(){return!1},parse:function(c){c=c.chat;c._submit_url=this.url.replace(".json","/messages.json");return c}})});h("chat/views/message",["text!chat/templates/message/show.html","chat/init","chat/libs/md5","chat/models/message"],function(c){var e=jQuery,b=Datajam.Chat;b.views.Message=
Backbone.View.extend({linkP:/https?:\/\/[\w\-\/#\.%\?\+\~\!\|=&:,|]+[\w\-\/#=&]/g,imageP:/\.(jpe?g|gif|png|bmp|tiff?)$/,events:{"click .edit":"edit","click .delete":"delete"},tagName:"li",className:"message clearfix",initialize:function(){_.bindAll(this,"delete","edit","getLinks","getImages","parentModel","parentView","render","_imgify","_linkify","_url");this.model||(this.model=new b.models.Message);this.model.bind("change",this.render)},"delete":function(a){a.preventDefault();var f=this.parentModel();
f&&(f.get("is_admin")&&this.$el.parents(".datajamChatAdmin").length)&&(Datajam.debug("deleting"),confirm("Really delete this comment?")&&(this.model.url=this._url(),this.model.set({text:b.constants.deleted_message_text}),this.model.save().success(_.bind(function(){f.collection.remove(this.model)},this))))},edit:function(a){var f=this.parentModel();if(f&&f.get("is_admin")&&this.$el.parents(".datajamChatAdmin").length){a.preventDefault();var c=prompt("Enter the new text",this.model.get("text"));Datajam.debug(c);
c&&c!=this.model.get("text")&&(this.model.url=this._url(),this.model.set({text:c}),this.model.save().success(_.bind(function(){c==b.constants.deleted_message_text&&f.collection.remove(this.model)},this)))}},getLinks:function(){return this.model.get("text").match(this.linkP)},getImages:function(){var a=this.getLinks();return _(a).filter(_.bind(function(a){return a.search(this.imageP)},this))},parentModel:function(){return this.parentView()&&this.parentView().model||null},parentView:function(){return this.$el.parents(".datajamChatThread").data("chat")||
null},render:function(){var a=this.model.toJSON(),b=this.parentModel();a.text=_(a.text).chain().striptags().linkify(this.linkP).imgify(this.imageP).spaceify().linebreaks().value();this.$el.attr("id","message_"+a._id).attr("data-timestamp",a.updated_at);b&&b.get("is_admin")&&this.$el.addClass("sunlight");this.$el.html(_.template(c,a));this.delegateEvents();return this},_imgify:function(a){var a=e("<div>"+a+"</div>"),b=this.imageP;a.find("a").each(function(){-1<e(this).text().search(b)&&e(this).html('<img src="'+
e(this).html()+'" />')});return a.html()},_linebreaks:function(a){return a.replace(/\n/g,"<br>")},_linkify:function(a){a=a.replace(this.linkP,function(a){return a.link(a)});return a.replace("<a ",'<a target="_blank" ')},_spaceify:function(a){return a.replace(/(\s)\s/g,"$1&nbsp;")},_strip_tags:function(a){return e("<div>"+a+"</div>").text()},_url:function(){return this.parentModel().url.replace(/\.json*/,"/messages/"+this.model.id+".json")}})});h("chat/views/chat","text!chat/templates/chat/show.html text!chat/templates/chat/closed.html text!chat/templates/chat/error.html text!chat/templates/chat/identity.html text!chat/templates/common/flash.html text!chat/templates/message/new.html chat/init chat/models/chat chat/models/message chat/views/message chat/collections/message".split(" "),
function(c,e,b,a,f,h){var g=jQuery,i=Datajam.Chat;i.views.Chat=Backbone.View.extend({events:{"submit form[name=new_message]":"submit","submit form[name=identify]":"identify","blur textarea":"handleBlur","click .destroyIdentity":"destroyIdentity","click .attachFile":"uploadDialog","change #chat_asset":"uploadFile","focus textarea":"handleFocus","keydown textarea":"handleKeyDown","chatWindow:scroll":"handleScroll"},initialize:function(){_.bindAll(this,"addMessage","archive","bootstrap","close","destroy",
"destroyIdentity","disableSubmit","enableSubmit","error","handleBlur","handleChange","handleFocus","handleKeyDown","handleScroll","identify","loading","loaded","open","pause","pollForContent","pollForOpenness","prevPage","removeMessage","render","resume","submit","uploadDialog","uploadFile");this.loading();this.$el.data("chat",this);this.model=new i.models.Chat;this.model.url=this.$el.attr("data-url");this.model.set({interval:this.$el.attr("data-interval"),_scroll_anchored:true});this.model.bind("change",
this.render);this.model.bind("change",this.handleChange);g.ajax({url:"/chats/identity.json",dataType:"json"}).success(_.bind(function(d){d.display_name&&this.model.set({display_name:d.display_name,is_admin:d.is_admin},{silent:true})},this));this.pollForOpenness()},addMessage:function(d){var a=this.$el.find(".commentsClip"),b=a.find(".comments"),c=a.scrollTop(),g=b.height(),f=b.find("li"),e=new i.views.Message({model:d});this.model.set({interval:this.$el.attr("data-interval")},{silent:true});f.length&&
this.collection.indexOf(d)<f.length?f.eq(this.collection.indexOf(d)).before(e.render().$el):b.append(e.render().$el);this.model.get("_scroll_anchored")||b.find("img").imagesLoaded(_.bind(function(){var d=b.height()-g;a.scrollTo(c+d)},this))},archive:function(d){Datajam.debug("archiving");d&&this.bootstrap(d);d&&this.pollForContent();this.$el.removeClass("closed").removeClass("open").addClass("archived");this.model.set({is_open:false,is_archived:true});this.pause()},bootstrap:function(d){Datajam.debug("bootstrapping");
if(this.collection){this.collection._oldest_seen_page=this.collection.url;this.collection.reset()}else{this.collection=new i.collections.Message;this.collection.bind("add",this.addMessage);this.collection.bind("remove",this.removeMessage);this.collection.ajaxOptions=d.ajaxOptions;this.collection.url=this.model.url.replace(".json","/pages/"+d.page._id+".json");this.collection._newest_seen_page=this.collection.url;this.collection._oldest_seen_page=d.page.prev_page;this.collection.view=this;this.model.collection=
this.collection}this.$el.children(".commentsClip").trigger("scroll")},close:function(){Datajam.debug("closing");this.model.set({is_open:false,is_archived:false});this.$el.removeClass("archived").removeClass("open").addClass("closed");this.pollForOpenness()},destroy:function(){this.pause();this.$el.html("")},destroyIdentity:function(d){d.preventDefault();this.model.get("display_name")&&g.ajax({url:"/chats/identity.json",type:"post",dataType:"json",data:{display_name:this.model.get("display_name"),
_method:"delete"}});this.model.set({display_name:null})},disableSubmit:function(){this.$el.find("form").addClass("disabled")},enableSubmit:function(){this.$el.find("form").removeClass("disabled")},error:function(){this.$el.html(_.template(b,{}))},flash:function(d){d=g(_.template(f,d));this.$el.find("form .well").eq(0).append(d);d.hide().fadeIn().delay(4E3).fadeOut(function(){g(this).remove()})},handleBlur:function(d){this._focusTimeout=setTimeout(_.bind(function(){this.model.set({_keep_focus:false},
{silent:true});g(d.target).parents(".datajamChatThread").removeClass("active")},this),1500)},handleChange:function(){Datajam.debug("model changed");!this.model.get("is_open")&&!this.model.get("is_archived")&&this.pollForOpenness()},handleFocus:function(d){this._focusTimeout&&clearTimeout(this._focusTimeout);this.model.set({_keep_focus:true},{silent:true});g(d.target).parents(".datajamChatThread").addClass("active")},handleKeyDown:function(d){d.keyCode===13&&(d.ctrlKey||d.metaKey)&&g(d.target).parents("form").submit()},
handleScroll:function(){var d,a;d=this.$el.find("div.commentsClip");a=d.find(".comments");d.scrollTop()===0?this.model.set({_scroll_anchored:true},{silent:true}):this.model.set({_scroll_anchored:false},{silent:true});if(d.height()+d.scrollTop()>=a.height()){this.loading();g.when(this.prevPage()).then(_.bind(function(){this.loaded();setTimeout(_.bind(function(){d.height()>=a.height()&&d.trigger("scroll")},this),1E3)},this)())}},identify:function(a){a.preventDefault();(a=this.$el.find("input[name=display_name]").val())&&
g.ajax({url:"/chats/identity.json",type:"post",dataType:"json",data:{display_name:a}}).success(_.bind(function(a){a.errors?this.flash({type:"error",message:a.errors.join("<br/>")}):a.display_name&&this.model.set({display_name:a.display_name,_keep_focus:true})},this)).error(_.bind(function(){this.flash({type:"error",message:"There was an error identifying you, please try again."})},this))},loading:function(){this.$el.addClass("loading")},loaded:function(){this.$el.removeClass("loading")},open:function(a){Datajam.debug("opening");
this.model.set({is_open:true,is_archived:false});this.bootstrap(a);this.$el.removeClass("archived").removeClass("closed").addClass("open");this.resume()},pause:function(){Datajam.debug("pausing");this.model.set({paused:true},{silent:true})},pollForContent:function(){Datajam.debug("polling...");if(this._timeout){clearTimeout(this._timeout);this._timeout=null}if(this._request){this._request.abort();this._request=null}this._request=this.collection.fetch(g.extend({add:true},this.model.get("ajaxOptions")));
if(this.$el.children().length===0){Datajam.debug("something went wrong. rescuing...");this.render().collection.reset()}if(!this.model.get("paused"))this._timeout=setTimeout(this.pollForContent,this.model.get("interval"))},pollForOpenness:function(){Datajam.debug("polling for openness");if(this._timeout){clearTimeout(this._timeout);this._timeout=null}this.model.fetch().success(_.bind(function(a){a.chat.is_open&&this.open(a);a.chat.is_archived&&this.archive(a);if(!a.chat.is_open&&!a.chat.is_archived){this.render();
this._timeout=setTimeout(this.pollForOpenness,this.model.get("interval"))}},this)).error(this.error).complete(this.loaded)},prevPage:function(){if(this.collection._oldest_seen_page){Datajam.debug("prev page");var a=g.Deferred();this.collection.fetch(g.extend({add:true,url:this.collection._oldest_seen_page},this.model.get("ajaxOptions")));return a.promise()}return true},removeMessage:function(a){(a=this.$el.find(".comments").find("li#message_"+a.id))&&a.remove()},render:function(){Datajam.debug("rendering");
var d=_(this.model.toJSON()).extend(Datajam.csrf),b=_.template(c),g=_.template(e),f=_.template(a),i=_.template(h);if(!d._id){Datajam.debug("No chat id found, returning from render...");return this}if(!d.is_open&&!d.is_archived){this.$el.html(g(d));return this}if(!this.$el.children().not(".closed").length){this.$el.html("");this.$el.append(b(d));this.$el.find(".commentsClip").scroll(_.bind(function(){this.$el.trigger("chatWindow:scroll")},this))}this.$el.find("form, .archived").remove();d.is_open?
this.model.get("display_name")?this.$el.find(".tip").after(i(d)):this.$el.find(".tip").after(f(d)):this.$el.find(".tip").remove();d.is_archived&&this.$el.prepend('<p class="archived">This is an archived event, comments are no longer being accepted.</p>');this.model.get("_keep_focus")&&this.$el.find("textarea, input[type=text]").focus();this.delegateEvents();return this},resume:function(){Datajam.debug("resuming");this.model.set({paused:false},{silent:true});this.pollForContent()},submit:function(a){a.preventDefault();
this.$el.find("form textarea").eq(0).focus();if(!this.$el.find("form").eq(0).hasClass("disabled"))if(a=this.$el.find("textarea").val()){this.disableSubmit();message=new i.models.Message({text:a});message.url=this.model.get("_submit_url");message.save(null,{dataType:"json",success:_.bind(function(a){this.$el.find("textarea").val("");a.is_public?this.model.set({interval:500},{silent:true}):this.flash({type:"info",message:"Your message is awaiting moderation."});this.pollForContent()},this),error:_.bind(function(a,
b){var d;(d=JSON.parse(b.responseText).errors)&&d.text?this.flash({type:"error",message:"Text "+d.text[0]}):this.flash({type:"error",message:"There was a problem posting your message."})},this),complete:this.enableSubmit})}},uploadDialog:function(a){a.preventDefault();g(g(a.target).attr("href")).trigger("click")},uploadFile:function(a){g(a.target).val()&&g(a.target).parents("form").ajaxSubmit({dataType:"json",success:_.bind(function(b){if(b&&b.url){var c=g(a.target).parents("form").prev("form").find("textarea");
c.val(c.val()+location.protocol+"//"+location.host+b.url);g(a.target).val("");c.focus()}else this.flash({type:"error",message:"Upload failed. Accepted file types are png, jpg, gif."})},this)})}})});h("chat/views/chat_controls",["text!chat/templates/chat/controls.html","chat/init","chat/models/chat"],function(c){var e=jQuery;Datajam.Chat.views.ChatControls=Backbone.View.extend({events:{"change select":"submit"},initialize:function(){_.bindAll(this,"submit","render");this.$el.data("chat-controls",this);
this.statuses=[{is_open:!1,is_archived:!1},{is_open:!0,is_archived:!1},{is_open:!1,is_archived:!0}];try{var b=this.$el.parents(".modal").attr("id").replace("modal-","");this.model=e("#chat_area_"+b).data("chat").model;return this.render()}catch(a){return Datajam.debug("Caught `"+a+"` initializing controls, no model associated."),this}},render:function(){this.$el.html(c);var b={is_open:this.model.get("is_open"),is_archived:this.model.get("is_archived")},a=null;_(this.statuses).each(function(c,e){_.isEqual(c,
b)&&(a=e+1)},this);a&&this.$el.find("select").val(a);return this},submit:function(){console.log(this.model.isNew());var b=this.$el.find("select");(b=b.length?b.first().val():null)&&this.model.save(this.statuses[b-1]);return this}})});h("chat/views/incoming_message",["text!chat/templates/message/incoming.html","chat/init","chat/views/message","chat/models/message"],function(c){var e=jQuery,b=Datajam.Chat;b.views.IncomingMessage=b.views.Message.extend({events:{"click .approve":"approve","click .reject":"reject"},
initialize:function(){_.bindAll(this,"approve","empty","getImages","getLinks","loading","parentModel","parentView","reject","render","_url");this.model||(this.model=new b.models.Message);this.model.bind("change",this.render)},approve:function(a){a.preventDefault();this.loading();this.model.url=this._url();this.model.set({is_moderated:!0,is_public:!0},{silent:!0});this.model.save().success(_.bind(function(){e("#"+this.$el.attr("id")).remove()},this)).error(function(){alert("There was an error approving this message.")})},
empty:function(){this.$el.html("")},loading:function(){this.$el.addClass("loading")},reject:function(a){a.preventDefault();this.loading();this.model.url=this._url();this.model.set({is_moderated:!0,is_public:!1},{silent:!0});this.model.save().success(_.bind(function(){e("#"+this.$el.attr("id")).remove()},this)).error(function(){alert("There was an error rejecting this message.")})},render:function(){var a=this.model.toJSON(),b=this.parentModel();a.text=this._strip_tags(a.text);a.text=this._linkify(a.text);
a.text=this._imgify(a.text);a.text=this._spaceify(a.text);a.text=this._linebreaks(a.text);this.$el.attr("id","message_"+a._id).attr("data-timestamp",a.updated_at);b&&b.get("is_admin")&&this.$el.addClass("sunlight");this.$el.html(_.template(c,a));this.delegateEvents();return this}})});h("chat/views/rejected_message",["text!chat/templates/message/rejected.html","chat/init","chat/views/message","chat/models/message"],function(c){var e=jQuery,b=Datajam.Chat;b.views.RejectedMessage=b.views.Message.extend({className:"message rejected",
events:{"click .approve":"approve","click .deleteAttachments":"deleteAttachments"},initialize:function(){_.bindAll(this,"approve","deleteAttachments","empty","getImages","getLinks","loading","parentModel","parentView","render","_url");this.model||(this.model=new b.models.Message);this.model.bind("change",this.render)},approve:function(a){a.preventDefault();this.loading();this.model.url=this._url();this.model.set({is_moderated:!0,is_public:!0},{silent:!0});this.model.save().success(_.bind(function(){e("#"+
this.$el.attr("id")).remove()},this)).error(function(){alert("There was an error approving this message.")})},deleteAttachments:function(a){a.preventDefault();var b=this.getImages(),c=[];_(b).each(function(a){c.push(_.last(a.split("/")))});c=_(c).compact();c.length&&e.ajax({url:"/chats/upload.json",type:"POST",dataType:"json",data:{_method:"delete",filenames:c},success:_.bind(function(a){if(a){var c=this.model.get("text");_(b).each(function(a){c=c.replace(a,"")});this.model.url=this._url();this.model.set({text:c});
this.model.save()}},this)})},empty:function(){this.$el.html("")},loading:function(){this.$el.addClass("loading")},render:function(){var a=this.model.toJSON(),b=this.parentModel();a.text=this._strip_tags(a.text);a.text=this._linkify(a.text);a.text=this._imgify(a.text);a.text=this._spaceify(a.text);a.text=this._linebreaks(a.text);this.$el.attr("id","message_"+a._id).attr("data-timestamp",a.updated_at);b&&b.get("is_admin")&&this.$el.addClass("sunlight");this.$el.html(_.template(c,a));this.delegateEvents();
return this}})});h("chat/views/moderator_chat","text!chat/templates/chat/show.html text!chat/templates/chat/closed.html text!chat/templates/chat/error.html text!chat/templates/common/flash.html chat/init chat/models/moderator_chat chat/models/message chat/views/incoming_message chat/views/rejected_message chat/collections/moderator_message".split(" "),function(c,e,b){var a=jQuery,f=Datajam.Chat,h={incoming:f.views.IncomingMessage,rejected:f.views.RejectedMessage};f.views.ModeratorChat=Backbone.View.extend({events:{},
initialize:function(){_.bindAll(this,"destroy","error","loading","loaded","pause","poll","render","renderCollection","resume","updateTopbarBadge");this.loading();this.$el.data("chat",this);this.model=new f.models.ModeratorChat;this.model.url=this.$el.attr("data-url");this.model.set({interval:this.$el.attr("data-interval"),_scroll_anchored:true});this.model.bind("change",this.render);this.collection=new f.collections.ModeratorMessage;this.collection.url=this.model.url.replace(".json","/messages.json")+
"?status="+this.$el.attr("data-status");this.collection.view=this;this.collection.bind("reset",this.renderCollection);this.views={};this.$el.attr("data-status")=="rejected"&&_.extend(this.collection,{comparator:function(a){return Date.parse(a.get("updated_at"))*-1}});this.model.fetch().success(_.bind(function(a){this.collection.ajaxOptions=_.extend({},a.ajaxOptions,{});this.model.set({name:_(this.$el.attr("data-status")).capitalize()});this.poll()},this)).error(this.error).complete(this.loaded)},
destroy:function(){this.pause(true);this.$el.html("")},error:function(){this.$el.html(_.template(b,{}))},loading:function(){this.$el.addClass("loading")},loaded:function(){this.$el.removeClass("loading")},pause:function(){this.model.set({paused:true},{silent:true})},poll:function(){if(this._timeout){clearTimeout(this._timeout);this._timeout=null}if(!this.model.get("paused")){this.collection.fetch();this._timeout=setTimeout(this.poll,this.model.get("interval"))}},render:function(){var a=this.model.toJSON(),
b=_.template(c);this.$el.html(b(a));this.$el.find("h3").eq(0).html(this.model.get("name"));this.$el.find("p.tip").eq(0).remove();return this},renderCollection:function(){var a=this.$el.find(".commentsClip").find(".comments");a.empty();this.collection.each(_.bind(function(b){var d=this.views[b.id];if(!d){d=new (h[this.$el.attr("data-status")])({model:b});this.views[b.id]=d}a.append(d.render().el)},this));this.updateTopbarBadge()},resume:function(){this.model.set({paused:false},{silent:true});this.poll()},
updateTopbarBadge:function(){if(this.collection.url.match("incoming")){var b=a(window.parent.document),c=b.find(".chat-modal[data-chat-id="+this.model.id+"]");if(c.length){var b=b.find(".topbar-nav a[data-controls-modal="+c.attr("id")+"]").eq(0),c=b.find(".badge"),d=this.$el.find("li").length;c.length||(c=b.append(' <span class="badge badge-warning"></span>').find(".badge"));c.html(d);d===0?c.hide():c.show()}}}})});var j=jQuery;k(["chat/init","chat/views/chat"],function(){j(function(){var c=Datajam.Chat;
j(".datajamChatThread").not(".moderator").each(function(){new c.views.Chat({el:j(this)})});j(".datajamChatThread.moderator").each(function(){k(["chat/views/moderator_chat"],_.bind(function(){new c.views.ModeratorChat({el:j(this)})},this))})})})})(jQuery,define,require);
