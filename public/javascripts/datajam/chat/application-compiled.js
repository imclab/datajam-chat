/**
 * Datajam Chat build file
 * Do not edit this file directly -- run `rake chat:build`
 */

(function($, define, require){

/*jshint laxcomma:true, expr:true, evil:true */
(function($, define, require){

  define('chat/init', [ 'datajam/init'
         , 'chat/libs/underscore_mixins'
         , 'chat/libs/jquery.imagesloaded'
         , 'chat/libs/jquery.scrollTo-1.4.2-min'
         , 'chat/libs/jquery.form'
         , '//cdnjs.cloudflare.com/ajax/libs/moment.js/1.7.0/moment.min.js'
         , '//platform.twitter.com/widgets.js'
         ], function(){

    window.Datajam || (Datajam = {});
    Datajam.Chat = {
        models: {}
      , views: {}
      , collections: {}
    };
    Datajam.Chat.constants = {
      deleted_message_text: '[deleted]'
    };
  });

})(jQuery, define, require);
/*jshint laxcomma:true, evil:true, expr:true */
(function(define, require){
  define('chat/collections/message', ['chat/init'], function(){
    var $ = jQuery
      , App = Datajam.Chat
      ;

      App.collections.Message = Backbone.Collection.extend({
          add: function(models, options){
            if(_.isArray(models)){
              $.each(models, _.bind(function(idx, model){
                model = this._clean(model);
                this.handle_message(model, options);
              }, this));
            }else{
              model = this._clean(models);
              this.handle_message(model, options);
            }
            return this;
          }
        , handle_message: function(model, options){
            var existing = this.get(model._id);
            if(!existing){
              if(model.text && model.text != App.constants.deleted_message_text){
                Backbone.Collection.prototype.add.call(this, model, options);
              }
            }else if(model.updated_at > existing.get('updated_at')){
              if(model.text && model.text != App.constants.deleted_message_text){
                existing.set(model);
              }else if(model.text == App.constants.deleted_message_text){
                this.remove(existing);
              }
            }
          }
        , comparator: function(obj){
            return 0 - obj.get('timestamp').toDate().valueOf();
          }
        , parse: function(resp, xhr) {
            var page = '/chats/' + resp.chat._id + '/pages/' + resp.page._id + '.json';
            // set paging bounds if they're not already set by the parent model...
            if(typeof this._oldest_seen_page == 'undefined'){
              this._oldest_seen_page = page;
            }
            if(typeof this._newest_seen_page == 'undefined'){
              this._newest_seen_page = page;
            }
            // if we are on the oldest seen page, bump it back one;
            // if there's a newer page, set it forward.
            if(page == this._oldest_seen_page){
              this._oldest_seen_page = resp.page.prev_page;
            }
            if(page == this._newest_seen_page){
              if(resp.page.next_page){
                this.url = resp.page.next_page;
                this._newest_seen_page = resp.page.next_page;
              }
            }
            // Separation of concerns (n). Not this.
            if(!resp.chat.is_open && !resp.chat.is_archived && !_.isEqual(resp.chat, this.view.model.toJSON())){
              this.view.close();
            }else if(!resp.chat.is_open && resp.chat.is_archived && !_.isEqual(resp.chat, this.view.model.toJSON())){
              this.view.archive();
            }
            return resp.page.messages;
          }
        , _clean: function(model) {
            model.timestamp = moment(model.updated_at, 'YYYY-MM-DDTHH:mm:ss');
            return model;
          }
      });
  });
})(define, require);
/*jshint laxcomma:true, evil:true, expr:true */
(function(define, require){
  define('chat/collections/moderator_message', ['chat/init'], function(){

    var $ = jQuery
      , App = Datajam.Chat
      ;

      App.collections.ModeratorMessage = Backbone.Collection.extend({
          comparator: function(obj){
            return Date.parse(obj.get('updated_at'));
          }
        , parse: function(resp, xhr) {
            return resp.messages;
          }
      });

  });
})(define, require);
/*jshint laxcomma:true, evil:true, expr:true */
(function(define, require){
  define('chat/models/chat', ['chat/init'], function(){
    var $ = jQuery
      , App = Datajam.Chat
      ;

      App.models.Chat = Backbone.Model.extend({
          defaults: {
              'ajaxOptions': {
                  cache: ($.browser.msie) ? false : true
              }
          }
        , initialize: function(){}
        , isNew: function(){
          return false;
        }
        , parse: function(data){
            var model;
            model = data.chat;
            try{
              model._newest_seen_page = '/chats/' + data.chat._id + '/pages/' + data.page._id + '.json';
              model._oldest_seen_page = data.page.prev_page || model._newest_seen_page;
            }catch(e){
              model._newest_seen_page = null;
              model._oldest_seen_page = null;
            }
            model._submit_url = this.url.replace('.json', '/messages.json');
            return model;
          }

      });
  });
})(define, require);
/*jshint laxcomma:true, evil:true, expr:true */
(function(define, require){
  define('chat/models/message', ['chat/init'], function(){
    var $ = jQuery
      , App = Datajam.Chat
      ;

      App.models.Message = Backbone.Model.extend({

      });

  });
})(define, require);
/*jshint laxcomma:true, evil:true, expr:true */
(function(define, require){
  define('chat/models/moderator_chat', ['chat/init'], function(){
    var $ = jQuery
      , App = Datajam.Chat
      ;

      App.models.ModeratorChat = Backbone.Model.extend({
          defaults: {}
        , initialize: function(){}
        , isNew: function(){
          return false;
        }
        , parse: function(data){
            var model;
            model = data.chat;
            model._submit_url = this.url.replace('.json', '/messages.json');
            return model;
          }

      });

  });
})(define, require);
/*jshint laxcomma:true, evil:true, expr:true */
(function(define, require){
  define('chat/views/message', [
      'text!chat/templates/message/show.html'
    , 'chat/init'
    , 'chat/libs/md5'
    , 'chat/models/message' ], function(showtmpl){

    var $ = jQuery
      , App = Datajam.Chat
      ;

      App.views.Message = Backbone.View.extend({
          linkP: /https?:\/\/[\w\-\/#\.%\?\+\~\!\|=&:,|]+[\w\-\/#=&]/g
        , imageP: /\.(jpe?g|gif|png|bmp|tiff?)$/
        , events: {
              'click .edit': 'edit'
            , 'click .delete': 'delete'
          }
        , tagName: 'li'
        , className: 'message clearfix'
        , initialize: function(args){
            _.bindAll(this
                    , 'delete'
                    , 'edit'
                    , 'getLinks'
                    , 'getImages'
                    , 'parentModel'
                    , 'parentView'
                    , 'render'
                    , '_imgify'
                    , '_linkify'
                    , '_url'
                    );

            this.model || (this.model = new App.models.Message());
            this.model.bind('change', this.render);
          }
        , 'delete': function(evt){
            evt.preventDefault();
            var parent_model = this.parentModel();
            if(parent_model && parent_model.get('is_admin') && this.$el.parents('.datajamChatAdmin').length){
              Datajam.debug('deleting');
              if(confirm('Really delete this comment?')){
                this.model.url = this._url();
                this.model.set({text: App.constants.deleted_message_text});
                this.model.save().success(_.bind(function(){
                  parent_model.collection.remove(this.model);
                }, this));
              }
            }
          }
        , edit: function(evt){
            var parent_model = this.parentModel();
            if(parent_model && parent_model.get('is_admin') && this.$el.parents('.datajamChatAdmin').length){
              evt.preventDefault();
              var text = prompt("Enter the new text", this.model.get('text'));
              Datajam.debug(text);
              if(text && text != this.model.get('text')){
                this.model.url = this._url();
                this.model.set({text: text});
                this.model.save().success(_.bind(function(){
                  // delete if deleted
                  if(text == App.constants.deleted_message_text){
                    parent_model.collection.remove(this.model);
                  }
                }, this));
              }
            }
          }
        , getLinks: function(){
            return this.model.get('text').match(this.linkP);
          }
        , getImages: function(){
            var links = this.getLinks();
            return _(links).filter(_.bind(function(link){
              return link.search(this.imageP);
            }, this));
          }
        , parentModel: function(){
            return (this.parentView() && this.parentView().model) || null;
          }
        , parentView: function(){
            // gets the chat that this message belongs to
            return this.$el.parents('.datajamChatThread').data('chat') || null;
          }
        , render: function(){
            var data = this.model.toJSON()
              , parent_model = this.parentModel();
            data.text = _(data.text).chain()
              .striptags()
              .linkify(this.linkP)
              .imgify(this.imageP)
              .spaceify()
              .linebreaks()
              .value();
            // set up the container element because replacing it is too painful
            this.$el.attr('id', 'message_' + data._id)
                      .attr('data-timestamp', data.updated_at);
            if(parent_model && parent_model.get('is_admin')) this.$el.addClass('sunlight');
            this.$el.html(_.template(showtmpl, data));
            this.delegateEvents();
            return this;
          }
        , _imgify: function(text){
            var html = $('<div>' + text + '</div>')
              , imageP = this.imageP;
            html.find('a').each(function(){
              if($(this).text().search(imageP) > -1){
                $(this).html('<img src="' + $(this).html() + '" />');
              }
            });
            return html.html();
          }
        , _linebreaks: function(text){
            return text.replace(/\n/g, '<br>');
          }
        , _linkify: function(text){
            text = text.replace(this.linkP, function(match,offset){return match.link(match);});
            return text.replace('<a ', '<a target="_blank" ');
          }
        , _spaceify: function(text){
            return text.replace(/(\s)\s/g, '$1&nbsp;');
          }
        , _strip_tags: function(text){
            return $('<div>' + text + '</div>').text();
          }
        , _url: function(){
            return this.parentModel().url.replace(/\.json*/, '/messages/' + this.model.id + '.json');
          }
      });

  });
})(define, require);
/*jshint laxcomma:true, expr:true, evil:true */
(function(define, require){
  define('chat/views/chat', [
      'text!chat/templates/chat/show.html'
    , 'text!chat/templates/chat/closed.html'
    , 'text!chat/templates/chat/error.html'
    , 'text!chat/templates/chat/identity.html'
    , 'text!chat/templates/common/flash.html'
    , 'text!chat/templates/message/new.html'
    , 'chat/init'
    , 'chat/models/chat'
    , 'chat/models/message'
    , 'chat/views/message'
    , 'chat/collections/message' ], function(showtmpl, closedtmpl, errortmpl, identitytmpl, flashtmpl, newmessagetmpl){

    var $ = jQuery
      , App = Datajam.Chat
      ;

      App.views.Chat = Backbone.View.extend({
          events: {
              "submit form[name=new_message]": "submit"
            , "submit form[name=identify]": "identify"
            , "blur textarea": "handleBlur"
            , "click .destroyIdentity": "destroyIdentity"
            , "click .attachFile": "uploadDialog"
            , "change #chat_asset": "uploadFile"
            , "focus textarea": "handleFocus"
            , "keydown textarea": "handleKeyDown"
            , "chatWindow:scroll": "handleScroll"
          }
        , initialize: function(){
            //scope class methods
            _.bindAll(this, 'addMessage'
                          , 'archive'
                          , 'bootstrap'
                          , 'close'
                          , 'destroy'
                          , 'destroyIdentity'
                          , 'disableSubmit'
                          , 'enableSubmit'
                          , 'error'
                          , 'handleBlur'
                          , 'handleChange'
                          , 'handleFocus'
                          , 'handleKeyDown'
                          , 'handleScroll'
                          , 'identify'
                          , 'loading'
                          , 'loaded'
                          , 'open'
                          , 'pause'
                          , 'pollForContent'
                          , 'pollForOpenness'
                          , 'prevPage'
                          , 'removeMessage'
                          , 'render'
                          , 'resume'
                          , 'submit'
                          , 'uploadDialog'
                          , 'uploadFile'
                          );
            this.loading();

            this.$el.data('chat', this);
            this.model = new App.models.Chat();
            this.model.url = this.$el.attr('data-url');
            this.model.set({interval: this.$el.attr('data-interval'), _scroll_anchored: true });
            this.model.bind('change', this.render);
            this.model.bind('change', this.handleChange);

            // get identity if available
            $.ajax({
              'url': '/chats/identity.json',
              'dataType': 'json'
            }).success(_.bind(function(data){
              if (data.display_name){
                this.model.set({
                    'display_name': data.display_name
                  , 'is_admin': data.is_admin
                }, {silent: true});
              }
            }, this));

            this.pollForOpenness();

          }
        , addMessage: function(model){
            var clipper = this.$el.find('.commentsClip')
              , scroller = clipper.find('.comments')
              , offset = clipper.scrollTop()
              , height = scroller.height()
              , items = scroller.find('li')
              , message = new App.views.Message({
                     model: model
                });

            // make sure the polling timeout is something sane
            this.model.set({interval:this.$el.attr('data-interval')}, {'silent': true});

            // append in order
            if(items.length && this.collection.indexOf(model) < items.length){
              items.eq(this.collection.indexOf(model)).before(message.render().$el);
            }else{
              scroller.append(message.render().$el);
            }

            // maintain scroll offset if not anchored
            if(!this.model.get('_scroll_anchored')){
              scroller.find('img').imagesLoaded(_.bind(function(){
                var diff = scroller.height() - height;
                clipper.scrollTo(offset+ diff);
              }, this));
            }
          }
        , archive: function(model){
            Datajam.debug('archiving');
            model && this.bootstrap(model);
            model && this.pollForContent();
            this.$el.removeClass('closed').removeClass('open').addClass('archived');
            this.model.set({'is_open': false, 'is_archived': true});
            this.pause();
          }
        , bootstrap: function(model){
            Datajam.debug('bootstrapping');
            if(!this.collection){
              this.collection = new App.collections.Message();
              this.collection.bind('add', this.addMessage);
              this.collection.bind('remove', this.removeMessage);
              this.collection.ajaxOptions = model.ajaxOptions;
              this.collection.url = this.model.url.replace('.json', '/pages/' + model.page._id + '.json');
              this.collection._newest_seen_page = this.collection.url;
              this.collection._oldest_seen_page = model.page.prev_page;
              this.collection.view = this;
              this.model.collection = this.collection;
            }else{
              this.collection._oldest_seen_page = this.collection.url;
              this.collection.reset();
            }
            // trigger scroll once just in case we opened to a blank page
            this.$el.children('.commentsClip').trigger('scroll');
          }
        , close: function(){
            Datajam.debug('closing');
            this.model.set({'is_open': false, 'is_archived': false});
            this.$el.removeClass('archived').removeClass('open').addClass('closed');
            this.pollForOpenness();
          }
        , destroy: function(){
            this.pause();
            this.$el.html('');
          }
        , destroyIdentity: function(evt){
            evt.preventDefault();
            if(this.model.get('display_name')){
              $.ajax({
                  url: '/chats/identity.json'
                , type: 'post'
                , dataType: 'json'
                , data: {display_name: this.model.get('display_name'), _method: 'delete'}
              });
            }
            this.model.set({'display_name': null});
          }
        , disableSubmit: function(){
            this.$el.find('form').addClass('disabled');
          }
        , enableSubmit: function(){
            this.$el.find('form').removeClass('disabled');
          }
        , error: function(){
            this.$el.html(_.template(errortmpl, {}));
          }
        , flash: function(data){
            var msg = $(_.template(flashtmpl, data));
            this.$el.find('form .well').eq(0).append(msg);
            msg.hide()
               .fadeIn()
               .delay(4000)
               .fadeOut(function(){$(this).remove();});
          }
        , handleBlur: function(evt){
            this._focusTimeout = setTimeout(_.bind(function(){
              this.model.set({'_keep_focus': false}, {'silent': true});
              $(evt.target).parents('.datajamChatThread').removeClass('active');
            }, this), 1500);
          }
        , handleChange: function(evt){
            Datajam.debug('model changed');
            if(!this.model.get('is_open') && !this.model.get('is_archived')){
              this.pollForOpenness();
            }
          }
        , handleFocus: function(evt){
            if(this._focusTimeout){
              clearTimeout(this._focusTimeout);
            }
            this.model.set({'_keep_focus': true}, {'silent': true});
            $(evt.target).parents('.datajamChatThread').addClass('active');
          }
        , handleKeyDown: function(evt){
            if(evt.keyCode === 13 && (evt.ctrlKey || evt.metaKey)){
              // submit with jQuery so analytics can be bolted on from outside
              $(evt.target).parents('form').submit();
            }
          }
        , handleScroll: function(evt){
            var clipper, scroller;
            clipper = this.$el.find('div.commentsClip');
            scroller = clipper.find('.comments');
            // anchor if user scrolls to the top of the range
            if(clipper.scrollTop() === 0){
            // if(clipper.height() + clipper.scrollTop() >= scroller.height()){
              this.model.set({'_scroll_anchored': true}, {'silent': true});
            }else{
              this.model.set({'_scroll_anchored': false}, {'silent': true});
            }
            // page back if user scrolls to the end of the range
            if(clipper.height() + clipper.scrollTop() >= scroller.height()){
              this.loading();
              $.when(this.prevPage()).then(_.bind(function(){
                  this.loaded();
                  setTimeout(_.bind(function(){
                    if(clipper.height() >= scroller.height()){
                      clipper.trigger('scroll');
                    }
                  }, this), 1000);
              }, this)());
            }
          }
        , identify: function(evt){
            evt.preventDefault();
            // evt.stopPropagation();
            var display_name = this.$el.find('input[name=display_name]').val();
            if(display_name){
              $.ajax({
                  url: '/chats/identity.json'
                , type: 'post'
                , dataType: 'json'
                , data: {
                      display_name: display_name
                  }
              }).success(_.bind(function(data){
                if(data.errors){
                  this.flash({type:'error', message:data.errors.join("<br/>")});
                }else if(data.display_name){
                  this.model.set({'display_name':data.display_name, '_keep_focus': true});
                }
              }, this)
              ).error(_.bind(function(data){
                this.flash({type:'error', message:'There was an error identifying you, please try again.'});
              }, this));
            }
          }
        , loading: function(){
            this.$el.addClass('loading');
          }
        , loaded: function(){
            this.$el.removeClass('loading');
          }
        , open: function(model){
            Datajam.debug('opening');
            this.model.set({
                  'is_open': true
                , 'is_archived': false
            });
            this.bootstrap(model);
            this.$el.removeClass('archived').removeClass('closed').addClass('open');
            this.resume();
          }
        , pause: function(){
            Datajam.debug('pausing');
            this.model.set({'paused': true}, {'silent': true});
          }
        , pollForContent: function(){
            Datajam.debug('polling...');
            if(this._timeout){
              clearTimeout(this._timeout);
              this._timeout = null;
            }
            if(this._request){
              this._request.abort();
              this._request = null;
            }
            this._request = this.collection.fetch($.extend({'add':true}, this.model.get('ajaxOptions')));

            // before requeuing, make sure we have rendered something by now
            Datajam.debug(this.$el);
            if(this.$el.children().length === 0){
              Datajam.debug('something went wrong. rescuing...');
              this.render().collection.reset();
            }
            if(!this.model.get('paused')){
              this._timeout = setTimeout(this.pollForContent, this.model.get('interval'));
            }
          }
        , pollForOpenness: function(){
            Datajam.debug('polling for openness');
            if(this._timeout){
              clearTimeout(this._timeout);
              this._timeout = null;
            }
            this.model.fetch()
              .success(_.bind(function(model){
                if(model.chat.is_open){
                  this.open(model);
                }
                if(model.chat.is_archived){
                  this.archive(model);
                }
                if(!model.chat.is_open && !model.chat.is_archived){
                  this.render();
                  this._timeout = setTimeout(this.pollForOpenness, this.model.get('interval'));
                }
              }, this))
              .error(this.error)
              .complete(this.loaded);
          }
        , prevPage: function(){
            if(this.collection._oldest_seen_page){
              Datajam.debug('prev page');
              var dfd = $.Deferred();
              this.collection.fetch($.extend({
                    'add':true
                  , 'url': this.collection._oldest_seen_page
                }
                , this.model.get('ajaxOptions')));
              return dfd.promise();
            }else{
              return true;
            }
          }
        , removeMessage: function(model){
            var scroller = this.$el.find('.comments')
              , item = scroller.find('li#message_' + model.id);
            item && item.remove();
          }
        , render: function(){
            Datajam.debug('rendering');
            var data = _(this.model.toJSON()).extend(Datajam.csrf)
              , html = _.template(showtmpl)
              , closedmessage = _.template(closedtmpl)
              , identityform = _.template(identitytmpl)
              , submitform = _.template(newmessagetmpl);

            // if the model doesn't have an id, skip for now
            if(!data._id){
              Datajam.debug('No chat id found, returning from render...');
              Datajam.debug(data);
              return this;
            }

            // if the model is closed, render the closed message
            if(!data.is_open && !data.is_archived){
              this.$el.html(closedmessage(data));
              return this;
            }

            // only redraw the thread if we aren't identified...
            if(! this.$el.children().not('.closed').length){
              this.$el.html('');

              this.$el.append(html(data));
              // use jquery to synthesize scroll events, triggering an event
              // on an element via backbone builtin handler requires the event to bubble
              this.$el.find('.commentsClip').scroll(_.bind(function(){
                this.$el.trigger('chatWindow:scroll');
              }, this));
            }

            // draw the correct form, if needed
            this.$el.find('form, .archived').remove();
            if(data.is_open){
              if(this.model.get('display_name')){
                this.$el.find('.tip').after(submitform(data));
              }else{
                this.$el.find('.tip').after(identityform(data));
              }
            }else{
              this.$el.find('.tip').remove();
            }
            if(data.is_archived){
              this.$el.prepend('<p class="archived">This is an archived event, comments are no longer being accepted.</p>');
            }

            // focus if focus is sticky
            if(this.model.get('_keep_focus')){
              this.$el.find('textarea, input[type=text]').focus();
            }
            this.delegateEvents();
            return this;
          }
        , resume: function(){
            Datajam.debug('resuming');
            this.model.set({'paused': false}, {'silent': true});
            this.pollForContent();
          }
        , submit: function(evt){
            evt.preventDefault();
            // evt.stopPropagation();
            this.$el.find('form textarea').eq(0).focus();
            if(this.$el.find('form').eq(0).hasClass('disabled')){
              return;
            }
            var text;
            text = this.$el.find('textarea').val();
            if(text){
              this.disableSubmit();
              message = new App.models.Message({text: text});
              message.url = this.model.get('_submit_url');
              message.save(null, {
                  dataType: 'json'
                , success: _.bind(function(data){
                    this.$el.find('textarea').val('');
                    if(!data.is_public){
                      this.flash({type: 'info', message: 'Your message is awaiting moderation.'});
                    }else{
                      // fast-poll 'til the message comes back down
                      this.model.set({interval:500}, {'silent': true});
                    }
                    this.pollForContent();
                  }, this)
                , error: _.bind(function(model, xhr){
                    var errors;
                    if((errors = JSON.parse(xhr.responseText).errors) && errors.text){
                      this.flash({type: 'error', message: 'Text ' + errors.text[0]});
                    }else{
                      this.flash({type: 'error', message: 'There was a problem posting your message.'});
                    }
                  }, this)
                , complete: this.enableSubmit
              });
            }
          }
        , uploadDialog: function(evt){
            evt.preventDefault();
            $($(evt.target).attr('href')).trigger('click');
          }
        , uploadFile: function(evt){
            if($(evt.target).val()){
              $(evt.target).parents('form')
                .ajaxSubmit({
                    dataType: 'json'
                  , success: _.bind(function(response){
                      // iframe transport w/ jquery.form doesn't seem to be aware of status codes.
                      // so, we check for a url attribute to know if it worked.
                      if(response && response.url){
                        var textarea = $(evt.target).parents('form').prev('form').find('textarea');
                        textarea.val(textarea.val() + location.protocol + '//' + location.host + response.url);
                        $(evt.target).val('');
                        textarea.focus();
                      }else{
                        this.flash({type:'error', message:'Upload failed. Accepted file types are png, jpg, gif.'});
                      }
                    }, this)
                });
            }
          }
      });
  });
})(define, require);
/*jshint laxcomma:true, evil:true, expr:true */
(function(define, require){
  define('chat/views/chat_controls', [
      'text!chat/templates/chat/controls.html'
    , 'chat/init'
    , 'chat/models/chat' ], function(controlstmpl){

    var $ = jQuery
      , App = Datajam.Chat
      ;

      App.views.ChatControls = Backbone.View.extend({
          events: {
              "change select": "submit"
          }
        , initialize: function(){
            _.bindAll(this, 'submit'
                          , 'render'
                          );
            this.$el.data('chat-controls', this);
            this.statuses = [
                {is_open: false, is_archived: false}
              , {is_open: true, is_archived: false}
              , {is_open: false, is_archived: true}
            ];
            try{
              var modal = this.$el.parents('.modal')
                , areaId = modal.attr('id').replace('modal-', '');
              this.model = $('#chat_area_' + areaId).data('chat').model;
              return this.render();
            }catch(e){
              Datajam.debug('Caught `' + e + '` initializing controls, no model associated.');
              return this;
            }
          }
        , render: function(){
            this.$el.html(controlstmpl);
            var status = {
                    is_open: this.model.get('is_open')
                  , is_archived: this.model.get('is_archived')
                }
              , val = null;
            _(this.statuses).each(function(obj, idx, statuses){
              if(_.isEqual(obj, status)){
                val = idx + 1;
              }
            }, this);
            val && this.$el.find('select').val(val);
            return this;
          }
        , submit: function(){
            console.log(this.model.isNew());
            var select = this.$el.find('select')
              , idx = (select.length) ? (select.first().val()) : null;
            idx && this.model.save(this.statuses[idx-1]);
            return this;
          }
      });
  });
})(define, require);
/*jshint laxcomma:true, evil:true, expr:true */
(function(define, require){
  define('chat/views/incoming_message', [
      'text!chat/templates/message/incoming.html'
    , 'chat/init'
    , 'chat/views/message'
    , 'chat/models/message' ], function(showtmpl){

    var $ = jQuery
      , App = Datajam.Chat
      ;

      App.views.IncomingMessage = App.views.Message.extend({
          events: {
              "click .approve": "approve"
            , "click .reject": "reject"
          }
        , initialize: function(args){
            _.bindAll(this
                    , 'approve'
                    , 'empty'
                    , 'getImages'
                    , 'getLinks'
                    , 'loading'
                    , 'parentModel'
                    , 'parentView'
                    , 'reject'
                    , 'render'
                    , '_url');

            this.model || (this.model = new App.models.Message());
            this.model.bind('change', this.render);
          }
        , approve: function(evt){
            evt.preventDefault();
            this.loading();
            this.model.url = this._url();
            this.model.set({is_moderated:true, is_public: true}, {silent: true});
            this.model.save()
              .success(_.bind(function(){
                $('#' + this.$el.attr('id')).remove();
              }, this))
              .error(function(){
                alert('There was an error approving this message.');
              });

          }
        , empty: function(){
            this.$el.html('');
          }
        , loading: function(){
            this.$el.addClass('loading');
          }
        , reject: function(evt){
            evt.preventDefault();
            this.loading();
            this.model.url = this._url();
            this.model.set({is_moderated:true, is_public: false}, {silent: true});
            this.model.save()
              .success(_.bind(function(){
                $('#' + this.$el.attr('id')).remove();
              }, this))
              .error(function(){
                alert('There was an error rejecting this message.');
              });
          }
        , render: function(){
            var data = this.model.toJSON()
              , parent_model = this.parentModel();
            data.text = this._strip_tags(data.text);
            data.text = this._linkify(data.text);
            data.text = this._imgify(data.text);
            data.text = this._spaceify(data.text);
            data.text = this._linebreaks(data.text);
            // set up the container element because replacing it is too painful
            this.$el.attr('id', 'message_' + data._id)
                      .attr('data-timestamp', data.updated_at);
            if(parent_model && parent_model.get('is_admin')) this.$el.addClass('sunlight');
            this.$el.html(_.template(showtmpl, data));
            this.delegateEvents();
            return this;
          }
      });

  });
})(define, require);
/*jshint laxcomma:true, evil:true, expr:true */
(function(define, require){
  define('chat/views/rejected_message', [
      'text!chat/templates/message/rejected.html'
    , 'chat/init'
    , 'chat/views/message'
    , 'chat/models/message' ], function(showtmpl){

    var $ = jQuery
      , App = Datajam.Chat
      ;

      App.views.RejectedMessage = App.views.Message.extend({
          className: 'message rejected'
        , events: {
              "click .approve": "approve"
            , "click .deleteAttachments": "deleteAttachments"
          }
        , initialize: function(args){
            _.bindAll(this
                    , 'approve'
                    , 'deleteAttachments'
                    , 'empty'
                    , 'getImages'
                    , 'getLinks'
                    , 'loading'
                    , 'parentModel'
                    , 'parentView'
                    , 'render'
                    , '_url');

            this.model || (this.model = new App.models.Message());
            this.model.bind('change', this.render);
          }
        , approve: function(evt){
            evt.preventDefault();
            this.loading();
            this.model.url = this._url();
            this.model.set({is_moderated:true, is_public: true}, {silent: true});
            this.model.save()
              .success(_.bind(function(){
                $('#' + this.$el.attr('id')).remove();
              }, this))
              .error(function(){
                alert('There was an error approving this message.');
              });

          }
        , deleteAttachments: function(evt){
            evt.preventDefault();
            var urls = this.getImages()
              , filenames = [];
            _(urls).each(function(url, idx){
              filenames.push(_.last(url.split('/')));
            });
            filenames = _(filenames).compact();
            if(filenames.length){
              $.ajax({
                  url: '/chats/upload.json'
                , type: 'POST'
                , dataType: 'json'
                , data: {
                      _method: 'delete'
                    , filenames: filenames
                  }
                , success: _.bind(function(response){
                    if(response){
                      var text = this.model.get('text');
                      _(urls).each(function(url, idx){
                        text = text.replace(url, '');
                      });
                      this.model.url = this._url();
                      this.model.set({text: text});
                      this.model.save();
                    }
                  }, this)
              });
            }
          }
        , empty: function(){
            this.$el.html('');
          }
        , loading: function(){
            this.$el.addClass('loading');
          }
        , render: function(){
            var data = this.model.toJSON()
              , parent_model = this.parentModel();
            data.text = this._strip_tags(data.text);
            data.text = this._linkify(data.text);
            data.text = this._imgify(data.text);
            data.text = this._spaceify(data.text);
            data.text = this._linebreaks(data.text);
            // set up the container element because replacing it is too painful
            this.$el.attr('id', 'message_' + data._id)
                      .attr('data-timestamp', data.updated_at);
            if(parent_model && parent_model.get('is_admin')) this.$el.addClass('sunlight');
            this.$el.html(_.template(showtmpl, data));
            this.delegateEvents();
            return this;
          }
      });

  });
})(define, require);
/*jshint laxcomma:true, evil:true, expr:true */
(function(define, require){
  define('chat/views/moderator_chat', [
      'text!chat/templates/chat/show.html'
    , 'text!chat/templates/chat/closed.html'
    , 'text!chat/templates/chat/error.html'
    , 'text!chat/templates/common/flash.html'
    , 'chat/init'
    , 'chat/models/moderator_chat'
    , 'chat/models/message'
    , 'chat/views/incoming_message'
    , 'chat/views/rejected_message'
    , 'chat/collections/moderator_message' ], function(showtmpl, closedtmpl, errortmpl, flashtmpl){

    var $ = jQuery
      , App = Datajam.Chat
      , message_classes = {
            'incoming': App.views.IncomingMessage
          , 'rejected': App.views.RejectedMessage
        }
      ;

      App.views.ModeratorChat = Backbone.View.extend({
          events: {

          }
        , initialize: function(){
            //scope class methods
            _.bindAll(this, 'destroy'
                          , 'error'
                          , 'loading'
                          , 'loaded'
                          , 'pause'
                          , 'poll'
                          , 'render'
                          , 'renderCollection'
                          , 'resume'
                          , 'updateTopbarBadge'
                          );

            this.loading();

            this.$el.data('chat', this);

            this.model = new App.models.ModeratorChat();
            this.model.url = this.$el.attr('data-url');
            this.model.set({interval: this.$el.attr('data-interval')
                          , _scroll_anchored: true
                          });
            this.model.bind('change', this.render);

            this.collection  = new App.collections.ModeratorMessage();
            this.collection.url = this.model.url.replace('.json', '/messages.json') + '?status=' + this.$el.attr('data-status');
            this.collection.view = this;
            this.collection.bind('reset', this.renderCollection);

            // total hack to keep from zombie-ing collection views
            this.views = {};

            // reverse sort for rejected queue
            if(this.$el.attr('data-status') == 'rejected'){
              _.extend(this.collection, {
                comparator: function(obj){
                  return Date.parse(obj.get('updated_at')) * -1; // reverse chron
                }
              });
            }

            this.model.fetch()
              .success(_.bind(function(model){
                this.collection.ajaxOptions = _.extend({}, model.ajaxOptions, {});
                this.model.set({name: _(this.$el.attr('data-status')).capitalize()});
                this.poll();
              }, this))
              .error(this.error)
              .complete(this.loaded);

          }
        , destroy: function(){
            this.pause(true);
            this.$el.html('');
          }
        , error: function(){
            this.$el.html(_.template(errortmpl, {}));
          }
        , loading: function(){
            this.$el.addClass('loading');
          }
        , loaded: function(){
            this.$el.removeClass('loading');
          }
        , pause: function(){
            this.model.set({'paused': true}, {'silent': true});
          }
        , poll: function(){
            if(this._timeout){
              clearTimeout(this._timeout);
              this._timeout = null;
            }
            if(!this.model.get('paused')){
              this.collection.fetch();
              this._timeout = setTimeout(this.poll, this.model.get('interval'));
            }
          }
        , render: function(){
            var data = this.model.toJSON()
              , tmpl = _.template(showtmpl);

            this.$el.html(tmpl(data));
            this.$el.find('h3').eq(0)
                    .html(this.model.get('name'));
            this.$el.find('p.tip').eq(0).remove();
            return this;
          }
        , renderCollection: function(){
            var scroller = this.$el.find('.commentsClip')
              , content = scroller.find('.comments');

            content.empty();
            this.collection.each(_.bind(function(model, idx){
              var message = this.views[model.id];
              if(!message){
                message = new message_classes[this.$el.attr('data-status')]({ model: model });
                this.views[model.id] = message;
              }
              content.append(message.render().el);
            }, this));
            this.updateTopbarBadge();
          }
        , resume: function(){
            this.model.set({'paused': false}, {'silent': true});
            this.poll();
          }
        , updateTopbarBadge: function(){
            if(!this.collection.url.match('incoming')) return;

            var parentDoc = $(window.parent.document)
              , modal = parentDoc.find('.chat-modal[data-chat-id=' + this.model.id + ']');
            if(!modal.length) return;

            var navLink = parentDoc.find('.topbar-nav a[data-controls-modal=' + modal.attr('id') + ']').eq(0)
              , badge = navLink.find('.badge')
              , count = this.$el.find('li').length;
            if(!badge.length){
              badge = navLink.append(' <span class="badge badge-warning"></span>').find('.badge');
            }
            badge.html(count);
            if(count === 0){
              badge.hide();
            }else{
              badge.show();
            }
          }
      });
  });
})(define, require);
/*jshint laxcomma:true, expr:true, evil:true */
/**
 * Datajam Chat
 * Rails Messaging Engine
 * @author Dan Drinkard <ddrinkard@sunlightfoundation.com>
 */
(function($, define, require){

  // Bootstrap the app
  require(['chat/init', 'chat/views/chat'], function(){

    $(function(){
      var App = Datajam.Chat;
      $('.datajamChatThread').not('.moderator').each(function(){
        new App.views.Chat({ el: $(this) });
      });
      $('.datajamChatThread.moderator').each(function(){
        require(['chat/views/moderator_chat'], _.bind(function(){
          new App.views.ModeratorChat({ el: $(this) });
        }, this));
      });
    });

  });

})(jQuery, define, require);
})(jQuery, define, require);
