(function(g,f,i){f("chat/common",[,"js!chat/plugins/underscore_mixins.js","js!chat/plugins/jquery.imagesloaded.js","js!chat/plugins/jquery.scrollTo-1.4.2-min.js","js!chat/plugins/moment.min.js"],function(){window.Datajam||(Datajam={});Datajam.Chat={Models:{},Views:{},Collections:{}};Datajam.Chat.csrf={csrf_param:g("meta[name=csrf-param]").attr("content"),csrf_token:g("meta[name=csrf-token]").attr("content")};g("document").bind("csrfloaded",function(){Datajam.Chat.csrf.csrf_token=g("meta[name=csrf-token]").attr("content")})});
f("chat/upload",["js!chat/plugins/jquery.form.js"],g.noop);f("chat/tweet",["js!//platform.twitter.com/widgets.js"],g.noop);f("chat/collections/message",["chat/common"],function(){var c=jQuery;Datajam.Chat.Collections.Message=Backbone.Collection.extend({add:function(b,d){_.isArray(b)?c.each(b,_.bind(function(a,b){b=this._clean(b);this.add_or_replace(b,d)},this)):(b=this._clean(b),this.add_or_replace(model,d));return this},add_or_replace:function(b,c){var a=this.get(b.id);a?b.updated_at>a.get("updated_at")&&
a.set(b):this._add(b,c)},comparator:function(b){return Date.parse(b.get("updated_at"))},parse:function(b){var c="/chats/"+b.chat._id+"/pages/"+b.page._id+".json";if(c==this._oldest_seen_page)this._oldest_seen_page=b.page.prev_page;else if(c==this._newest_seen_page&&b.page.next_page)this._newest_seen_page=this.url=b.page.next_page;!b.chat.is_open&&!_.isEqual(b.chat,this.view.model.toJSON())&&(this.view.model.set(b.chat),this.view.pause());return b.page.messages},_clean:function(b){b.id=b._id;delete b._id;
return b}})});f("chat/collections/moderator_message",["chat/common"],function(){Datajam.Chat.Collections.ModeratorMessage=Backbone.Collection.extend({comparator:function(c){return Date.parse(c.get("updated_at"))},parse:function(c){_(c.messages).each(function(b,d){c.messages[d].id=b._id;delete c.messages[d]._id});return c.messages}})});f("chat/models/chat",["chat/common"],function(){Datajam.Chat.Models.Chat=Backbone.Model.extend({defaults:{},initialize:function(){},parse:function(c){var b;c.chat.id=
c.chat._id;delete c.chat._id;b=c.chat;try{b._newest_seen_page="/chats/"+c.chat.id+"/pages/"+c.page._id+".json",b._oldest_seen_page=c.page.prev_page||b._newest_seen_page}catch(d){b._newest_seen_page=null,b._oldest_seen_page=null}b._submit_url=this.url.replace(".json","/messages.json");return b}})});f("chat/models/message",["chat/common"],function(){Datajam.Chat.Models.Message=Backbone.Model.extend({})});f("chat/models/moderator_chat",["chat/common"],function(){Datajam.Chat.Models.ModeratorChat=Backbone.Model.extend({defaults:{},
initialize:function(){},parse:function(c){c.chat.id=c.chat._id;delete c.chat._id;c=c.chat;c._submit_url=this.url.replace(".json","/messages/");return c}})});f("chat/views/message",["text!chat/templates/message/show.html","chat/common","chat/tweet","js!chat/plugins/md5.js","chat/models/message"],function(c){var b=jQuery,d=Datajam.Chat;d.Views.Message=Backbone.View.extend({linkP:/https?:\/\/[\w\-\/#\.%\?=&:,|]+[\w\-\/#=&]/g,imageP:/\.(jpe?g|gif|png|bmp|tiff?)$/,events:{click:"handleClick"},tagName:"li",
className:"message clearfix",initialize:function(){_.bindAll(this,"getLinks","getImages","handleClick","parentModel","parentView","render");this.model||(this.model=new d.Models.Message);this.model.bind("change",this.render)},getLinks:function(){return this.model.get("text").match(this.linkP)},getImages:function(){var a=this.getLinks();return _(a).filter(_.bind(function(a){return a.search(this.imageP)},this))},handleClick:function(a){var c=this.parentModel();if(c&&c.get("is_admin")&&b(this.el).parents(".datajamChatAdmin").length&&
(a.preventDefault(),(a=prompt("Enter the new text",this.model.get("text")))&&a!=this.model.get("text")))this.model.url=this._url(),this.model.set({text:a}),this.model.save()},parentModel:function(){return this.parentView()&&this.parentView().model||null},parentView:function(){return b(this.el).parents(".datajamChatThread").data("chat")||null},render:function(){var a=this.model.toJSON(),d=this.parentModel();a.text=_(a.text).chain().striptags().linkify(this.linkP).imgify(this.imageP).spaceify().linebreaks().value();
b(this.el).attr("id","message_"+a.id).attr("data-timestamp",a.updated_at);d&&d.get("is_admin")&&b(this.el).addClass("sunlight");b(this.el).html(_.template(c,a));this.delegateEvents();return this},_imgify:function(a){var a=b("<div>"+a+"</div>"),c=this.imageP;a.find("a").each(function(){-1<b(this).text().search(c)&&b(this).html('<img src="'+b(this).html()+'" />')});return a.html()},_linebreaks:function(a){return a.replace(/\n/g,"<br>")},_linkify:function(a){a=a.replace(this.linkP,function(a){return a.link(a)});
return a.replace("<a ",'<a target="_blank" ')},_spaceify:function(a){return a.replace(/(\s)\s/g,"$1&nbsp;")},_strip_tags:function(a){return b("<div>"+a+"</div>").text()},_url:function(){return this.parentModel().url.replace(/\.json*/,"/messages/"+this.model.id+".json")}})});f("chat/views/chat","text!chat/templates/chat/show.html,text!chat/templates/chat/closed.html,text!chat/templates/chat/error.html,text!chat/templates/chat/identity.html,text!chat/templates/common/flash.html,text!chat/templates/message/new.html,chat/common,chat/upload,chat/models/chat,chat/models/message,chat/views/message,chat/collections/message".split(","),
function(c,b,d,a,j,f){var e=jQuery,h=Datajam.Chat;h.Views.Chat=Backbone.View.extend({events:{"submit form[name=new_message]":"submit","submit form[name=identify]":"identify","blur textarea":"handleBlur","click .destroyIdentity":"destroyIdentity","click .attachFile":"uploadDialog","change #chat_asset":"uploadFile","focus textarea":"handleFocus","keydown textarea":"handleKeyDown","chatWindow:scroll":"handleScroll"},initialize:function(){_.bindAll(this,"addMessage","destroy","destroyIdentity","disableSubmit",
"enableSubmit","error","handleBlur","handleFocus","handleKeyDown","handleScroll","identify","loading","loaded","pause","pollForContent","pollForOpenness","prevPage","render","resume","submit","uploadDialog","uploadFile");this.loading();this.el.data("chat",this);this.model=new h.Models.Chat;this.model.url=this.el.attr("data-url");this.model.set({interval:this.el.attr("data-interval"),_scroll_anchored:!0});this.model.bind("change",this.render);e.ajax({url:"/chats/identity.json",dataType:"json"}).success(_.bind(function(a){a.display_name&&
this.model.set({display_name:a.display_name,is_admin:a.is_admin})},this));this.pollForOpenness()},addMessage:function(a){var b=this.el.find(".commentsClip"),c=b.find(".comments"),e=c.find("li"),d=new h.Views.Message({model:a});this.model.set({interval:this.el.attr("data-interval")},{slient:!0});e.length&&this.collection.indexOf(a)<e.length?e.eq(this.collection.indexOf(a)).before(d.render().el):c.append(d.render().el);c.height()<b.height()&&b.trigger("scroll");this.model.get("_scroll_anchored")?c.find("img").imagesLoaded(_.bind(function(){b.stop().scrollTo("100%",
100,"swing")},this)):this.anchor&&c.find("img").imagesLoaded(_.bind(function(){b.stop().scrollTo(this.anchor,_.bind(function(){this.anchor=null},this))},this))},destroy:function(){this.pause();this.el.html("")},destroyIdentity:function(a){a.preventDefault();this.model.get("display_name")&&e.ajax({url:"/chats/identity.json",type:"post",dataType:"json",data:{display_name:this.model.get("display_name"),_method:"delete"}});this.model.set({display_name:null})},disableSubmit:function(){this.el.find("form").addClass("disabled")},
enableSubmit:function(){this.el.find("form").removeClass("disabled")},error:function(){this.el.html(_.template(d,{}))},flash:function(a){a=e(_.template(j,a));this.el.find("form").eq(0).prepend(a);a.hide().fadeIn().delay(4E3).fadeOut(function(){e(this).remove()})},handleBlur:function(){this._focusTimeout=setTimeout(_.bind(function(){this.model.set({_keep_focus:!1},{silent:!0})},this),1500)},handleFocus:function(){this._focusTimeout&&clearTimeout(this._focusTimeout);this.model.set({_keep_focus:!0},
{silent:!0})},handleKeyDown:function(a){switch(a.keyCode){case 13:a.altKey||this.submit(a)}},handleScroll:function(){var a,b;a=this.el.find("div.commentsClip");b=a.find(".comments");a.height()+a.scrollTop()>=b.height()?this.model.set({_scroll_anchored:!0},{silent:!0}):this.model.set({_scroll_anchored:!1},{silent:!0});if(0==a.scrollTop())this.loading(),this.anchor=b.find("li:first"),e.when(this.prevPage()).then(this.loaded())},identify:function(a){a.preventDefault();a.stopPropagation();(a=e("input[name=display_name]").val())&&
e.ajax({url:"/chats/identity.json",type:"post",dataType:"json",data:{display_name:a}}).success(_.bind(function(a){a.errors?this.flash({type:"error",message:a.errors.join("<br/>")}):a.display_name&&this.model.set({display_name:a.display_name,_keep_focus:!0})},this)).error(_.bind(function(){this.flash({type:"error",message:"There was an error identifying you, please try again."})},this))},loading:function(){this.el.addClass("loading")},loaded:function(){this.el.removeClass("loading")},pause:function(){this.model.set({paused:!0},
{silent:!0})},pollForContent:function(){if(this._timeout)clearTimeout(this._timeout),this._timeout=null;this.collection.fetch(e.extend({add:!0},this.model.get("ajaxOptions")));this.el.children("ul.comments > li").length||this.el.children(".commentsClip").trigger("scroll");if(!this.model.get("paused"))this._timeout=setTimeout(this.pollForContent,this.model.get("interval"))},pollForOpenness:function(){if(this._timeout)clearTimeout(this._timeout),this._timeout=null;this.model.fetch().success(_.bind(function(a){a.chat.is_open||
a.chat.is_archived?(this.collection=new h.Collections.Message,this.collection.view=this,this.collection.bind("add",this.addMessage),this.collection.url=this.model.url.replace(".json","/pages/"+a.page._id+".json"),this.collection._newest_seen_page=this.collection.url,this.collection._oldest_seen_page=a.page.prev_page,this.collection.ajaxOptions=a.ajaxOptions,this.pollForContent(),a.chat.is_archived&&this.pause()):(this.render(),this._timeout=setTimeout(this.pollForOpenness,this.model.get("interval")))},
this)).error(this.error).complete(this.loaded)},prevPage:function(){if(this.collection._oldest_seen_page){var a=e.Deferred();this.collection.fetch(e.extend({add:!0,url:this.collection._oldest_seen_page},this.model.get("ajaxOptions")));return a.promise()}return!0},render:function(){var e=_(this.model.toJSON()).extend(h.csrf),d=_.template(c),j=_.template(b),g=_.template(a),i=_.template(f);if(!e.id)return this;if(!e.is_open&&!e.is_archived)return this.el.html(j),this;this.el.children().not(".closed").length||
(this.el.html(""),this.el.append(d(e)),this.el.find(".commentsClip").scroll(_.bind(function(){this.el.trigger("chatWindow:scroll")},this)));this.el.find("form, .archived").remove();e.is_open&&(this.model.get("display_name")?this.el.append(i(e)):this.el.append(g(e)));e.is_archived&&this.el.append('<p class="archived">This is an archived event, comments are closed.</p>');this.model.get("_keep_focus")&&this.el.find("textarea, input[type=text]").focus();this.delegateEvents();return this},resume:function(){this.model.set({paused:!1},
{silent:!0});this.pollForContent()},submit:function(a){a.preventDefault();a.stopPropagation();if(!this.el.find("form").eq(0).hasClass("disabled")&&(a=this.el.find("textarea").val()))this.disableSubmit(),message=new h.Models.Message({text:a}),message.url=this.model.get("_submit_url"),message.save(null,{dataType:"json",success:_.bind(function(a){this.el.find("textarea").val("");a.is_public?this.model.set({interval:500},{slient:!0}):this.flash({type:"info",message:"Your message is awaiting moderation."});
this.pollForContent()},this),error:_.bind(function(a,b){var c;(c=JSON.parse(b.responseText).errors)&&c.text?this.flash({type:"error",message:"Text "+c.text[0]}):this.flash({type:"error",message:"There was a problem posting your message."})},this),complete:this.enableSubmit})},uploadDialog:function(a){a.preventDefault();e(e(a.target).attr("href")).trigger("click")},uploadFile:function(a){e(a.target).val()&&e(a.target).parents("form").ajaxSubmit({dataType:"json",success:_.bind(function(b){if(b&&b.url){var c=
e(a.target).parents(".inputArea").find("textarea");c.val(c.val()+location.protocol+"//"+location.host+b.url);e(a.target).val("");c.focus()}else this.flash({type:"error",message:"Upload failed. Accepted file types are png, jpg, gif."})},this)})}})});f("chat/views/chat_controls",["text!chat/templates/chat/controls.html","chat/common","chat/models/chat"],function(c){var b=jQuery;Datajam.Chat.Views.ChatControls=Backbone.View.extend({events:{"change select":"submit"},initialize:function(){_.bindAll(this,
"submit","render");this.el.data("chat-controls",this);this.statuses=[{is_open:!1,is_archived:!1},{is_open:!0,is_archived:!1},{is_open:!1,is_archived:!0}];var c=this.el.parents(".modal").attr("id").replace("modal-","");try{this.model=b("#chat_area_"+c).data("chat").model}catch(a){}},render:function(){this.el.html(c);var b={is_open:this.model.get("is_open"),is_archived:this.model.get("is_archived")},a=null;_(this.statuses).each(function(c,f){_.isEqual(c,b)&&(a=f+1)},this);a&&this.el.find("select").val(a);
return this},submit:function(){var b=this.el.find("select");(b=b.length?b.first().val():null)&&this.model.save(this.statuses[b-1],{data:this.statuses[b-1]})}})});f("chat/views/incoming_message",["text!chat/templates/message/incoming.html","chat/common","chat/views/message","chat/models/message"],function(c){var b=jQuery,d=Datajam.Chat;d.Views.IncomingMessage=d.Views.Message.extend({events:{"click .approve":"approve","click .reject":"reject"},initialize:function(){_.bindAll(this,"approve","empty",
"getImages","getLinks","loading","parentModel","parentView","reject","render","_url");this.model||(this.model=new d.Models.Message);this.model.bind("change",this.render)},approve:function(a){a.preventDefault();this.loading();this.model.url=this._url();this.model.set({is_moderated:!0,is_public:!0},{silent:!0});this.model.save().success(_.bind(function(){b("#"+b(this.el).attr("id")).remove()},this)).error(function(){alert("There was an error approving this message.")})},empty:function(){b(this.el).html("")},
loading:function(){b(this.el).addClass("loading")},reject:function(a){a.preventDefault();this.loading();this.model.url=this._url();this.model.set({is_moderated:!0,is_public:!1},{silent:!0});this.model.save().success(_.bind(function(){b("#"+b(this.el).attr("id")).remove()},this)).error(function(){alert("There was an error rejecting this message.")})},render:function(){var a=this.model.toJSON(),d=this.parentModel();a.text=this._strip_tags(a.text);a.text=this._linkify(a.text);a.text=this._imgify(a.text);
a.text=this._spaceify(a.text);a.text=this._linebreaks(a.text);b(this.el).attr("id","message_"+a.id).attr("data-timestamp",a.updated_at);d&&d.get("is_admin")&&b(this.el).addClass("sunlight");b(this.el).html(_.template(c,a));this.delegateEvents();return this}})});f("chat/views/rejected_message",["text!chat/templates/message/rejected.html","chat/common","chat/views/message","chat/models/message"],function(c){var b=jQuery,d=Datajam.Chat;d.Views.RejectedMessage=d.Views.Message.extend({className:"message rejected",
events:{"click .approve":"approve","click .deleteAttachments":"deleteAttachments"},initialize:function(){_.bindAll(this,"approve","deleteAttachments","empty","getImages","getLinks","loading","parentModel","parentView","render","_url");this.model||(this.model=new d.Models.Message);this.model.bind("change",this.render)},approve:function(a){a.preventDefault();this.loading();this.model.url=this._url();this.model.set({is_moderated:!0,is_public:!0},{silent:!0});this.model.save().success(_.bind(function(){b("#"+
b(this.el).attr("id")).remove()},this)).error(function(){alert("There was an error approving this message.")})},deleteAttachments:function(a){a.preventDefault();var c=this.getImages(),d=[];_(c).each(function(a){d.push(_.last(a.split("/")))});d=_(d).compact();d.length&&b.ajax({url:"/chats/upload.json",type:"POST",dataType:"json",data:{_method:"delete",filenames:d},success:_.bind(function(a){if(a){var b=this.model.get("text");_(c).each(function(a){b=b.replace(a,"")});this.model.url=this._url();this.model.set({text:b});
this.model.save()}},this)})},empty:function(){b(this.el).html("")},loading:function(){b(this.el).addClass("loading")},render:function(){var a=this.model.toJSON(),d=this.parentModel();a.text=this._strip_tags(a.text);a.text=this._linkify(a.text);a.text=this._imgify(a.text);a.text=this._spaceify(a.text);a.text=this._linebreaks(a.text);b(this.el).attr("id","message_"+a.id).attr("data-timestamp",a.updated_at);d&&d.get("is_admin")&&b(this.el).addClass("sunlight");b(this.el).html(_.template(c,a));this.delegateEvents();
return this}})});f("chat/views/moderator_chat","text!chat/templates/chat/show.html,text!chat/templates/chat/closed.html,text!chat/templates/chat/error.html,text!chat/templates/common/flash.html,chat/common,chat/models/moderator_chat,chat/models/message,chat/views/incoming_message,chat/views/rejected_message,chat/collections/moderator_message".split(","),function(c,b,d){var a=jQuery,f=Datajam.Chat,g={incoming:f.Views.IncomingMessage,rejected:f.Views.RejectedMessage};f.Views.ModeratorChat=Backbone.View.extend({events:{},
initialize:function(){_.bindAll(this,"destroy","error","loading","loaded","pause","poll","render","renderCollection","resume","updateTopbarBadge");this.loading();this.el.data("chat",this);this.model=new f.Models.ModeratorChat;this.model.url=this.el.attr("data-url");this.model.set({interval:this.el.attr("data-interval"),_scroll_anchored:!0});this.model.bind("change",this.render);this.collection=new f.Collections.ModeratorMessage;this.collection.url=this.model.url.replace(".json","/messages.json")+
"?status="+this.el.attr("data-status");this.collection.view=this;this.collection.bind("reset",this.renderCollection);this.views={};"rejected"==this.el.attr("data-status")&&_.extend(this.collection,{comparator:function(a){return-1*Date.parse(a.get("updated_at"))}});this.model.fetch().success(_.bind(function(a){this.collection.ajaxOptions=_.extend({},a.ajaxOptions,{});this.model.set({name:_(this.el.attr("data-status")).capitalize()});this.poll()},this)).error(this.error).complete(this.loaded)},destroy:function(){this.pause();
this.el.html("")},error:function(){this.el.html(_.template(d,{}))},loading:function(){this.el.addClass("loading")},loaded:function(){this.el.removeClass("loading")},pause:function(){this.model.set({paused:!0},{silent:!0})},poll:function(){if(this._timeout)clearTimeout(this._timeout),this._timeout=null;if(!this.model.get("paused"))this.collection.fetch(),this._timeout=setTimeout(this.poll,this.model.get("interval"))},render:function(){var b=this.model.toJSON(),d=_.template(c);a(this.el).html(d(b));
return this},renderCollection:function(){var a=this.el.find(".commentsClip").find(".comments");a.empty();this.collection.each(_.bind(function(b){var c=this.views[b.id];c||(c=new (g[this.el.attr("data-status")])({model:b}),this.views[b.id]=c);a.append(c.render().el)},this));this.updateTopbarBadge()},resume:function(){this.model.set({paused:!1},{silent:!0});this.poll()},updateTopbarBadge:function(){if(this.collection.url.match("incoming")){var b=a(window.parent.document),c=b.find(".chat-modal[data-chat-id="+
this.model.get("id")+"]");if(c.length){var b=b.find(".nav a[data-controls-modal="+c.attr("id")+"]").eq(0),c=b.find(".badge"),d=a(this.el).find("li").length;c.length||(c=b.append('<span class="badge"></span>').find(".badge"));c.html(d);0==d?c.hide():c.show()}}}})});i(["chat/common","chat/views/chat"],function(){Backbone.emulateHTTP=!0;Backbone.emulateJSON=!0;g(function(){var c=Datajam.Chat;g(".datajamChatThread").not(".moderator").each(function(){new c.Views.Chat({el:g(this)})});g(".datajamChatThread.moderator").each(function(){i(["chat/views/moderator_chat"],
_.bind(function(){new c.Views.ModeratorChat({el:g(this)})},this))})})})})(jQuery,curl.define,curl);